%\documentclass[letterpaper,draft]{beamer}
\documentclass[letterpaper, mathserif, handout]{beamer}
%\documentclass[letterpaper]{beamer}

%---multiple pages on one sheet, ADD for handout--
%\usepackage{pgfpages}
%\pgfpagesuselayout{4 on 1}[letterpaper, landscape, border shrink=1mm]
%-------------------------------------------------
\usepackage{amsmath,amsfonts}
%\usepackage[misc]{ifsym} % for the dice symbol \Cube{}
%\usepackage{booktabs}
%\usepackage{mdwlist}
%\usepackage{pgf,tikz}
%\usetheme{Copenhagen}
%\usetheme{warsaw}
\setbeamertemplate{navigation symbols}{}
\usepackage[english]{babel}
\def\ul{\underline}
% or whatever

\usepackage[latin1]{inputenc}
\subject{Talks}

\def\P{\mathbb{P}}
\def\p{\mathrm P}
\def\E{\mathbb E}
\def\Sum{\sum\nolimits}
\def\X{\mathfrak{X}}
\def\typo#1{\alert{#1}}
%-------------Answers------------
\def\Hide#1#2{\ul{~~~\onslide<#1>{\alert{#2}}~~~}}
\def\hide#1#2{\ul{~~\onslide<#1>{\alert{#2}}~~}}
\def\hid#1#2{\onslide<#1>{\alert{#2}}}
%------Centered Page Number------
\input{Centerpgn}
\def\chapnum{2}
%--------------------------------
\setbeamertemplate{footline}[centered page number]
\title{STAT253/317 Winter 2024 Lecture \chapnum}
\date{}
\author{Cong Ma}
\begin{document}
% ----------------------------------------------------------------------
\begin{frame}\maketitle\bigskip
\begin{center}
4.2 Chapman-Kolmogorov Equation
\end{center}
\end{frame}
% ----------------------------------------------------------------------

% ----------------------------------------------------------------------
\begin{frame}{$n$-Step Transition Probabilities}
Suppose $\{X_n\}$ is a stationary Markov chain with state space $\X$.\par
Define the $n$-step transition probabilities
\[P_{ij}^{(n)}=\p(X_{n+k}=j \mid X_k=i)\quad\text{ for $i,j\in\X$ and }n,k=0,1,2,\ldots\]
How to calculate $P_{ij}^{(n)}$?
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Example: Ehrenfest Model, 4 Balls}
$$\P=
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4 \cr
0 &  0  &  1  &  0  &  0  &  0 \cr
1 & 1/4 &  0  & 3/4 &  0  &  0 \cr
2 &  0  & 2/4 &  0  & 2/4 &  0 \cr
3 &  0  &  0  & 3/4 &  0  & 1/4\cr
4 &  0  &  0  &  0  &  1  &  0
}
$$
\begin{itemize}
\item[Q1] Find $P^{(2)}_{4,2}=\p(X_2=2|X_0=4).$

\hid{2-}{Only one possible path: $4\to 3 \to 2$,\\ so $P^{(2)}_{4,2}=P_{4,3}P_{3,2}=1\cdot(3/4)=3/4.$}
\item[Q2] Find $P^{(3)}_{4,2}=\p(X_3=2|X_0=4).$

\hid{3-}{Impossible to go from 4 to 2 in odd number of steps,\\ so $P^{(3)}_{4,2}=0.$}
\end{itemize}
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}%{Example: Ehrenfest Model, 4 Balls (Cont'd)}

\[\P=
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4 \cr
0 &  0  &  1  &  0  &  0  &  0 \cr
1 & 1/4 &  0  & 3/4 &  0  &  0 \cr
2 &  0  & 2/4 &  0  & 2/4 &  0 \cr
3 &  0  &  0  & 3/4 &  0  & 1/4\cr
4 &  0  &  0  &  0  &  1  &  0
}
\]
\begin{itemize}
\item[Q3] Find $P^{(4)}_{4,2}=\p(X_4=2|X_0=4).$\smallskip

\onslide<2->{{\color{red}
Possible paths:

\vspace{-22pt}\[
\arraycolsep = 1pt
\begin{array}{lllllllll}
4 & \to & 3 & \to      & 4 & \to      & 3 & \to & 2\\
  &     &   & \searrow &   & \nearrow &   & \nearrow  & \\
  &     &   &          & 2 & \to      & 1 &     &
\end{array}
\]
\begin{align*}
P^{(4)}_{4,2}&=P_{4,3}P_{3,4}P_{4,3}P_{3,2}+P_{4,3}P_{3,2}P_{2,3}P_{3,2}+P_{4,3}P_{3,2}P_{2,1}P_{1,2}\\
&=1\cdot\frac{1}{4}\cdot1\cdot\frac{3}{4}+1\cdot\frac{3}{4}\cdot\frac{2}{4}\cdot\frac{3}{4}
 +1\cdot\frac{3}{4}\cdot\frac{2}{4}\cdot\frac{3}{4}= \frac{3}{4}
\end{align*}
}}
\item[Q4] Find $P^{(10)}_{4,2}=\p(X_{10}=2|X_0=4).$

\hid{3-}{Too many paths to list, likely to miss a few.}
\end{itemize}
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Chapman-Kolmogorov Equations}
Suppose $\{X_n\}$ is a stationary Markov chain with state space $\X$.\par
Define the $n$-step transition probabilities
$$P_{ij}^{(n)}=\p(X_{n+k}=j|X_k=i)\quad\text{ for $i,j\in\X$ and }n,k=0,1,2,\ldots$$
Then for all $m$, $n\ge 1$,
$$P_{ij}^{(m+n)}=\Sum_{k\in\X}P_{ik}^{(m)}P_{kj}^{(n)}$$
{\em Proof.}
\begin{align*}
P_{ij}^{(m+n)}&=\p(X_{m+n}=j|X_0=i)\\
&=\Sum_{k\in\X}\p(X_{m+n}=j,X_{m}=k|X_0=i)\\
&=\Sum_{k\in\X}\p(X_{m}=k|X_0=i)\p(X_{m+n}=j|X_{m}=k,X_0=i)\\
&=\Sum_{k\in\X}\p(X_{m}=k|X_0=i)\p(X_{m+n}=j|X_{m}=k)\quad(\text{Markov})\\
&=\Sum_{k\in\X}P_{ik}^{(m)}P_{kj}^{(n)}
\end{align*}
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Chapman-Kolmogorov Equation in Matrix Notation}
For $n=1,2,3,\ldots$, let
$$
\P^{(n)}=
\begin{pmatrix}
P^{(n)}_{00} & P^{(n)}_{01} & P^{(n)}_{02} & \cdots &P^{(n)}_{0j} & \cdots\\
P^{(n)}_{10} & P^{(n)}_{11} & P^{(n)}_{12} & \cdots &P^{(n)}_{1j} & \cdots\\
\vdots & \vdots & \vdots & \ddots &\vdots & \ddots\\
P^{(n)}_{i0} & P^{(n)}_{i1} & P^{(n)}_{i2} & \cdots &P^{(n)}_{ij} & \cdots\\
\vdots & \vdots & \vdots & \ddots &\vdots & \ddots
\end{pmatrix}
$$
be the \structure{$n$-step transition probability matrix}.

The Chapman-Kolmogorov equation just asserts that
$$\P^{(m+n)}=\P^{(m)}\times \P^{(n)}$$

Note $\P^{(1)}=\P$, $\Rightarrow$ $\P^{(2)}=\P^{(1)}\times \P^{(1)}=\P\times\P=\P^2$.

By induction,
$$\P^{(n)}=\P^{(n-1)}\times \P^{(1)}=\P^{n-1}\times\P=\P^n
$$
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}
Define $\pi_n (i)=\p(X_n=i)$, $i\in\X$ to be the marginal distribution of $X_n$, $n=1,2,\ldots.$
Then again by the law of total probabilities,
\begin{align}
\pi_{n}(j)&=\p(X_{n}=j)\cr
&=\Sum_{k\in\X}\p(X_{0}=k)\p(X_{n}=j|X_0=k)\label{eq:piP}\\
&=\Sum_{k\in\X}\pi_0(k)P_{kj}^{(n)}\nonumber
\end{align}
Suppose the state space $\X$ is $\{0,1,2,\ldots\}.$\par
If we write the marginal distribution of $X_n$ as a row vector
$$
\pi_n=(\pi_n(0),\pi_n(1),\pi_n(2),\ldots),
$$
then equation \eqref{eq:piP} is equivalent to
$$
\pi_n=\pi_0 \P^{(n)}= \pi_0 \P^{n}
$$
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Example: Ehrenfest Model, 4 Balls}
$$\P=
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4 \cr
0 &  0  & 4/4 &  0  &  0  &  0 \cr
1 & 1/4 &  0  & 3/4 &  0  &  0 \cr
2 &  0  & 2/4 &  0  & 2/4 &  0 \cr
3 &  0  &  0  & 3/4 &  0  & 1/4\cr
4 &  0  &  0  &  0  & 4/4 &  0
}
$$
\begin{itemize}
\item[Q3] Find $P^{(4)}_{4,2}=\p(X_4=2|X_0=4).$
\item[Q4] Find $P^{(10)}_{4,2}=\p(X_{10}=2|X_0=4).$
\item[Q5] Given $\p(X_0=i)=1/5$ for $i=0,1,2,3,4$, find $\p(X_4=2)$
\item[Q6] Find $\p(X_{10}=2, X_k\ge 2, \text{ for }1\le k\le 9|X_0=4)$
\end{itemize}
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}\small
$$\P^2=\P\times\P=
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4 \cr
0 & 1/4 &  0  & 3/4 &  0  &  0 \cr
1 &  0  & 5/8 &  0  & 3/8 &  0 \cr
2 & 1/8 &  0  & 3/4 &  0  & 1/8\cr
3 &  0  & 3/8 &  0  & 5/8 &  0 \cr
4 &  0  &  0  & 3/4 &  0  & 1/4
}
$$
$$
\P^3=\P\times\P^2=
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4 \cr
0 &  0  & 5/8 &  0  & 3/8 &  0 \cr
1 & 5/32&  0  & 3/4 &  0  & 3/32\cr
2 &  0  & 1/2 &  0  & 1/2 &  0 \cr
3 & 3/32&  0  & 3/4 &  0  & 5/32\cr
4 &  0  & 3/8 &  0  & 5/8 &  0
}
$$
$$\P^4=\P^2\times\P^2=
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4 \cr
0 & 5/32&  0  & 3/4 &  0  & 3/32\cr
1 &  0  &17/32&  0  &15/32&  0 \cr
2 & 1/8 &  0  & 3/4 &  0  & 1/8\cr
3 &  0  &15/32&  0  & 5/32&  0 \cr
4 & 3/32&  0  & 3/4 &  0  & 5/32
}
$$
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Example: Ehrenfest Model, 4 Balls (Cont'd)}
\begin{align*}
\P^4&=
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4  \cr
0 & 5/32&  0  & 3/4 &  0  & 3/32\cr
1 &  0  &17/32&  0  &15/32&  0  \cr
2 & 1/8 &  0  & 3/4 &  0  & 1/8 \cr
3 &  0  &15/32&  0  & 5/32&  0  \cr
4 & 3/32&  0  & \only<1-2|handout:0>{3/4}\only<3->{\alert{\fbox{3/4}}} &  0  & 5/32
}\\[-2pt]
\end{align*}
For Q3, $\p(X_4=2|X_0=4)=\only<1|handout:0>{?}\only<2->{\alert{P^{(4)}_{42}}}\hid{4-}{=3/4.}$

\hid{4-}{which agrees with our previous calculation.}
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Example: Ehrenfest Model, 4 Balls (Cont'd)}
To find $P^{(10)}_{4,2}$ for Q4, it's awful lots of work to compute $\P^{10}$\ldots\bigskip\pause

There are ways to save some work. By the C-K equation,
\[
\P^{(10)}_{4,2}=
\only<1-2|handout:0>{\P^{(5)}_{4,0}\P^{(5)}_{0,2}}\only<3->{\underbrace{\P^{(5)}_{4,0}\P^{(5)}_{0,2}}_{\alert{=0}}}+
\P^{(5)}_{4,1}\P^{(5)}_{1,2}+
\only<1-2|handout:0>{\P^{(5)}_{4,2}\P^{(5)}_{2,2}}\only<3->{\underbrace{\P^{(5)}_{4,2}\P^{(5)}_{2,2}}_{\alert{=0}}}+
\P^{(5)}_{4,3}\P^{(5)}_{3,2}+
\only<1-2|handout:0>{\P^{(5)}_{4,4}\P^{(5)}_{4,2}}\only<3->{\underbrace{\P^{(5)}_{4,4}\P^{(5)}_{4,2}}_{\alert{=0}}}
%&=0+\P^{(5)}_{4,1}\P^{(5)}_{1,2}+0+\P^{(5)}_{4,3}\P^{(5)}_{3,2}+0
\]
\onslide<3->{because it's impossible to move between even states in odd number of moves.}\bigskip

\onslide<4->{We just need to find $\P^{(5)}_{4,1}$, $\P^{(5)}_{4,3}$, $\P^{(5)}_{1,2}$, and $\P^{(5)}_{3,2}$.}
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Example: Ehrenfest Model, 4 Balls (Cont'd)}
\begin{align*}
\P^{5}&=\P^2\times \P^3\\
&={\scriptsize
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4 \cr
0 & 1/4 &  0  & 3/4 &  0  &  0 \cr
1 &  0  & 5/8 &  0  & 3/8 &  0 \cr
2 & 1/8 &  0  & 3/4 &  0  & 1/8\cr
3 &  0  & 3/8 &  0  & 5/8 &  0 \cr
4 &  0  &  0  & 3/4 &  0  & 1/4
}\times
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4 \cr
0 &  0  & 5/8 &  0  & 3/8 &  0 \cr
1 & 5/32&  0  & 3/4 &  0  &3/32\cr
2 &  0  & 1/2 &  0  & 1/2 &  0 \cr
3 & 3/32&  0  & 3/4 &  0  &5/32\cr
4 &  0  & 3/8 &  0  & 5/8 &  0
}}\\
&={\scriptsize
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4 \cr
0 &     &     &  0  &     &    \cr
1 &     &     & 3/4 &     &    \cr
2 &     &     &  0  &     &    \cr
3 &     &     & 3/4 &     &    \cr
4 &  0  &15/32&  0  &17/32&  0
}}
\end{align*}
So
\[
\P^{(10)}_{4,2}=\P^{(5)}_{4,1}\P^{(5)}_{1,2}+\P^{(5)}_{4,3}\P^{(5)}_{3,2}
= \frac{15}{32}\times\frac{3}{4}+\frac{17}{32}\times\frac{3}{4}=\frac{3}{4}.
\]
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Example: Ehrenfest Model, 4 Balls (Cont'd)}
Q5: Given $\p(X_0=i)=1/5$ for $i=0,1,2,3,4$, find $\p(X_4=2)$.

$$\pi_0=(\frac{1}{5},\frac{1}{5},\frac{1}{5},\frac{1}{5},\frac{1}{5}).$$

$$\pi_4=\pi_0 \P^4=
(\frac{1}{5},\frac{1}{5},\frac{1}{5},\frac{1}{5},\frac{1}{5})
\begin{pmatrix}
5/32&  0  & 3/4 &  0  & 3/32\cr
 0  &17/32&  0  &15/32&  0  \cr
1/8 &  0  & 3/4 &  0  & 1/8 \cr
 0  &15/32&  0  &17/32&  0  \cr
3/32&  0  & 3/4 &  0  & 5/32
\end{pmatrix}
$$

\begin{align*}
\pi_4(2)&= (\frac{1}{5},\frac{1}{5},\frac{1}{5},\frac{1}{5},\frac{1}{5})
\begin{pmatrix}
3/4\cr
 0 \cr
3/4\cr
 0 \cr
3/4
\end{pmatrix}\\
&=
\frac{1}{5}\cdot\frac{3}{4}+
\frac{1}{5}\cdot0+
\frac{1}{5}\cdot\frac{3}{4}+
\frac{1}{5}\cdot0+
\frac{1}{5}\cdot\frac{3}{4}=\frac{9}{20}
\end{align*}
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Example: Ehrenfest Model, 4 Balls (Cont'd)}
Q6: Find $\p(X_{10}=2, X_k\ge 2, \text{ for }1\le k\le 9|X_0=4).$ \bigskip

{\bf Tip}: Create another process $\{W_n,n=0,1,2,\ldots\}$ with an absorbing state $A$
$$
W_n =
\begin{cases}
X_n &\text{if } X_k\ge 2 \text{ for all }k = 0,1,2,\ldots,n\\
A   &\text{if } X_k <2   \text{ for some }k\le n
\end{cases}
$$
What is the state space of $\{W_n\}$? \hid{2-}{$\{A,2,3,4\}$}\pause

Is $\{W_n\}$ a Markov chain?\pause\pause
$$
W_{n+1} =
\begin{cases}
A     &\text{if }W_n=A\\
W_n+1 &\text{with prob. } \frac{4-W_n}{4}\text{ if }W_n\neq A\\
W_n-1 &\text{with prob. } \frac{W_n}{4}  \text{ if }W_n=3\text{ or }4\\
A     &\text{with prob. } \frac{W_n}{4}  \text{ if }W_n=2
\end{cases}
$$
\hid{3-}{Yes, $\{W_n\}$ is a Markov chain.}
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Example: Ehrenfest Model, 4 Balls (Cont'd)}
What is the transition probability of $\{W_n\}$?
$$
\P_W=
\bordermatrix{%
  &  A  &  2  &  3  &  4 \cr
A &  1  &  0 &  0  &  0 \cr
2 & 2/4 &{\color{red}0}  & {\color{red}2/4} & {\color{red}0}  \cr
3 &  0  &{\color{red}3/4}& {\color{red}0}   & {\color{red}1/4}\cr
4 &  0  &{\color{red}0}  & {\color{red}1}   & {\color{red}0}
}
$$
Observe that $\P_{W,i,j}$ equals the transition prob. or the original process
$\P_{i,j}$ for $i,j\neq A.$
$$
\P=
\bordermatrix{%
  &  0  &  1  &  2  &  3  &  4 \cr
0 &  0  & 4/4 &  0  &  0  &  0 \cr
1 & 1/4 &  0  & 3/4 &  0  &  0 \cr
2 &  0  & 2/4 & {\color{red}0}  & {\color{red}2/4} & {\color{red}0}  \cr
3 &  0  &  0  & {\color{red}3/4}& {\color{red}0}   & {\color{red}1/4}\cr
4 &  0  &  0  & {\color{red}0}  & {\color{red}1}   & {\color{red}0}
}
$$
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Example: Ehrenfest Model, 4 Balls (Cont'd)}
How does $\{W_n\}$ helps us to solve Q6?
\begin{align*}
\text{Observe that }&\p(X_{10}=2, X_k\ge 2, \text{ for }1\le k\le 9|X_0=4)\\
=\,&\p(W_{10}=2|W_0=4)=P^{(10)}_{W,4,2}
\end{align*}
It's still an awful lot of work to compute $P^{(10)}_{W,4,2}$.

By the same way we calculate $P^{(10)}_{4,2}$, using C-K equation, we know
\[
\P^{(10)}_{W,4,2}=
\P^{(5)}_{W,4,A}\underbrace{\P^{(5)}_{W,A,2}}_{\alert{=0}}+
\underbrace{\P^{(5)}_{W,4,2}\P^{(5)}_{W,2,2}}_{\alert{=0}}+
\P^{(5)}_{W,4,3}\P^{(5)}_{W,3,2}+
\underbrace{\P^{(5)}_{W,4,4}\P^{(5)}_{W,4,2}}_{\alert{=0}}
\]

\vspace{-12pt}in which
\begin{itemize}
\item $\P^{(5)}_{W,A,2}=0$ because $\{W_n\}$ will never leave $A.$
\item $\P^{(5)}_{W,4,2}=\P^{(5)}_{W,4,4}=0$  because $\{W_n\}$ can never get from 4 to an even numbered state in odd numbers of steps.
\end{itemize}
Just need to find $\P^{(5)}_{W,4,3}$ and $\P^{(5)}_{W,3,2}.$
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}{Example: Ehrenfest Model, 4 Balls (Cont'd)}
\[{\footnotesize\P_W^{(2)}=
\bordermatrix{%
  &  A  &  2  &  3  &  4 \cr
A &  1  &  0  &  0  &  0 \cr
2 & 1/2 & 3/8 &  0  &1/8\cr
3 & 3/8 &  0  & 5/8&  0 \cr
4 &  0  & 3/4 &  0  &1/4
},\quad
\P_W^{(3)}=
\bordermatrix{%
  &  A  &  2  &  3  &  4 \cr
A &  1  &  0  &  0  &  0 \cr
2 &11/16&  0  & 5/16&  0 \cr
3 & 3/8 &15/32&  0  &5/32\cr
4 & 3/8 &  0  & 5/8 &  0
}
}\]
\[
\P_W^{(5)}=\P_W^{(2)}\times \P_W^{(3)}
={\footnotesize
\bordermatrix{%
  &  A  &  2  &  3  &  4 \cr
A &  1  &  0  &  0  &  0 \cr
2 &     &  0  &     &    \cr
3 &     &75/256&    &    \cr
4 &     &  0  &25/64&
}}
\]
So
\[
\P^{(10)}_{W,4,2}=\P^{(5)}_{W,4,3}\P^{(5)}_{W,3,2}
= \frac{25}{64}\times\frac{75}{256}=\frac{1875}{16384}.
\]
\end{frame}
% ----------------------------------------------------------------------
\begin{frame}
For a generalization of Q6,
see the discussion starting from the bottom of p.202 to Example 4.14 on p.203 of
the 12th edition of the textbook (or p.192-193 of the 11th edition).

\end{frame}
% ----------------------------------------------------------------------
\end{document} 